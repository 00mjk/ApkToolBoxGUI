<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DumpsysAlarmPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">APKToolBoxGUI</a> &gt; <a href="index.source.html" class="el_package">edu.jiangxin.apktoolbox.android.dumpsys.alarm</a> &gt; <span class="el_source">DumpsysAlarmPanel.java</span></div><h1>DumpsysAlarmPanel.java</h1><pre class="source lang-java linenums">package edu.jiangxin.apktoolbox.android.dumpsys.alarm;

import edu.jiangxin.apktoolbox.file.core.EncoderDetector;
import edu.jiangxin.apktoolbox.swing.extend.EasyPanel;
import edu.jiangxin.apktoolbox.swing.treetable.MyAbstractTreeTableModel;
import edu.jiangxin.apktoolbox.swing.treetable.MyTreeTable;
import edu.jiangxin.apktoolbox.utils.Constants;
import org.apache.commons.exec.CommandLine;
import org.apache.commons.exec.DefaultExecutor;
import org.apache.commons.exec.PumpStreamHandler;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.StringUtils;

import javax.swing.*;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;

public class DumpsysAlarmPanel extends EasyPanel {

    private JPanel operationPanel;

    private JButton loadFromDeviceButton;

    private JButton loadFromFileButton;

    private JPanel lastDateTimePanel;

    private JLabel lastDateTimeLabel;

    private JTextField lastDateTimeField;

    private JPanel systemUptime1Panel;

    private JLabel systemUptime1Label;

    private JTextField systemUptime1Field;

    private JPanel systemUptime2Panel;

    private JLabel systemUptime2Label;

    private JTextField systemUptime2Field;

    private JPanel packagePanel;

    private JLabel packageLabel;

    private JTextField packageField;

    private JTabbedPane tabbedPane;

    private JPanel tabularFormTabPanel;

    private JPanel rawSourceTabPanel;

    private JEditorPane editorPane;

    private MyTreeTable myTreeTable;

    private AlarmTreeTableDataNode root;

    private List&lt;AlarmTreeTableDataNode&gt; children;

    private String alarmInfoString;

    private boolean alarmInfoValid;

    public DumpsysAlarmPanel() throws HeadlessException {
<span class="nc" id="L76">        super();</span>
<span class="nc" id="L77">        initUI();</span>
<span class="nc" id="L78">    }</span>

    private void initUI() {
<span class="nc" id="L81">        BoxLayout boxLayout = new BoxLayout(this, BoxLayout.Y_AXIS);</span>
<span class="nc" id="L82">        setLayout(boxLayout);</span>

<span class="nc" id="L84">        createOptionPanel();</span>
<span class="nc" id="L85">        add(operationPanel);</span>
<span class="nc" id="L86">        add(Box.createVerticalStrut(Constants.DEFAULT_Y_BORDER));</span>

<span class="nc" id="L88">        createLastDateTimePanel();</span>
<span class="nc" id="L89">        add(lastDateTimePanel);</span>
<span class="nc" id="L90">        add(Box.createVerticalStrut(Constants.DEFAULT_Y_BORDER));</span>

<span class="nc" id="L92">        createSystemUptime1Panel();</span>
<span class="nc" id="L93">        add(systemUptime1Panel);</span>
<span class="nc" id="L94">        add(Box.createVerticalStrut(Constants.DEFAULT_Y_BORDER));</span>

<span class="nc" id="L96">        createSystemUptime2Panel();</span>
<span class="nc" id="L97">        add(systemUptime2Panel);</span>
<span class="nc" id="L98">        add(Box.createVerticalStrut(Constants.DEFAULT_Y_BORDER));</span>

<span class="nc" id="L100">        createPackagePanel();</span>
<span class="nc" id="L101">        add(packagePanel);</span>
<span class="nc" id="L102">        add(Box.createVerticalStrut(Constants.DEFAULT_Y_BORDER));</span>

<span class="nc" id="L104">        createTabbedPane();</span>
<span class="nc" id="L105">        add(tabbedPane);</span>
<span class="nc" id="L106">    }</span>

    private void createOptionPanel() {
<span class="nc" id="L109">        operationPanel = new JPanel();</span>
<span class="nc" id="L110">        operationPanel.setLayout(new BoxLayout(operationPanel, BoxLayout.X_AXIS));</span>

<span class="nc" id="L112">        loadFromDeviceButton = new JButton(&quot;Load From Device&quot;);</span>
<span class="nc" id="L113">        loadFromDeviceButton.addMouseListener(new LoadFromDeviceButtonMouseAdapter());</span>

<span class="nc" id="L115">        loadFromFileButton = new JButton(&quot;Load From File&quot;);</span>
<span class="nc" id="L116">        loadFromFileButton.addMouseListener(new LoadFromFileButtonMouseAdapter());</span>

<span class="nc" id="L118">        operationPanel.add(loadFromDeviceButton);</span>
<span class="nc" id="L119">        operationPanel.add(Box.createHorizontalStrut(Constants.DEFAULT_X_BORDER));</span>
<span class="nc" id="L120">        operationPanel.add(loadFromFileButton);</span>
<span class="nc" id="L121">        operationPanel.add(Box.createHorizontalGlue());</span>
<span class="nc" id="L122">    }</span>

    private void createLastDateTimePanel() {
<span class="nc" id="L125">        lastDateTimePanel = new JPanel();</span>
<span class="nc" id="L126">        lastDateTimePanel.setLayout(new BoxLayout(lastDateTimePanel, BoxLayout.X_AXIS));</span>

<span class="nc" id="L128">        lastDateTimeLabel = new JLabel(&quot;Last DateTime&quot;);</span>

<span class="nc" id="L130">        lastDateTimeField = new JTextField();</span>

<span class="nc" id="L132">        lastDateTimePanel.add(lastDateTimeLabel);</span>
<span class="nc" id="L133">        lastDateTimePanel.add(Box.createHorizontalStrut(Constants.DEFAULT_X_BORDER));</span>
<span class="nc" id="L134">        lastDateTimePanel.add(lastDateTimeField);</span>
<span class="nc" id="L135">    }</span>

    private void createSystemUptime1Panel() {
<span class="nc" id="L138">        systemUptime1Panel = new JPanel();</span>
<span class="nc" id="L139">        systemUptime1Panel.setLayout(new BoxLayout(systemUptime1Panel, BoxLayout.X_AXIS));</span>

<span class="nc" id="L141">        systemUptime1Label = new JLabel(&quot;System Uptime(ms)&quot;);</span>

<span class="nc" id="L143">        systemUptime1Field = new JTextField();</span>

<span class="nc" id="L145">        systemUptime1Panel.add(systemUptime1Label);</span>
<span class="nc" id="L146">        systemUptime1Panel.add(Box.createHorizontalStrut(Constants.DEFAULT_X_BORDER));</span>
<span class="nc" id="L147">        systemUptime1Panel.add(systemUptime1Field);</span>
<span class="nc" id="L148">    }</span>

    private void createSystemUptime2Panel() {
<span class="nc" id="L151">        systemUptime2Panel = new JPanel();</span>
<span class="nc" id="L152">        systemUptime2Panel.setLayout(new BoxLayout(systemUptime2Panel, BoxLayout.X_AXIS));</span>

<span class="nc" id="L154">        systemUptime2Label = new JLabel(&quot;System Uptime&quot;);</span>

<span class="nc" id="L156">        systemUptime2Field = new JTextField();</span>

<span class="nc" id="L158">        systemUptime2Panel.add(systemUptime2Label);</span>
<span class="nc" id="L159">        systemUptime2Panel.add(Box.createHorizontalStrut(Constants.DEFAULT_X_BORDER));</span>
<span class="nc" id="L160">        systemUptime2Panel.add(systemUptime2Field);</span>
<span class="nc" id="L161">    }</span>

    private void createPackagePanel() {
<span class="nc" id="L164">        packagePanel = new JPanel();</span>
<span class="nc" id="L165">        packagePanel.setLayout(new BoxLayout(packagePanel, BoxLayout.X_AXIS));</span>

<span class="nc" id="L167">        packageLabel = new JLabel(&quot;Package&quot;);</span>

<span class="nc" id="L169">        packageField = new JTextField();</span>

<span class="nc" id="L171">        packagePanel.add(packageLabel);</span>
<span class="nc" id="L172">        packagePanel.add(Box.createHorizontalStrut(Constants.DEFAULT_X_BORDER));</span>
<span class="nc" id="L173">        packagePanel.add(packageField);</span>
<span class="nc" id="L174">    }</span>

    private void createTabbedPane() {
<span class="nc" id="L177">        tabbedPane = new JTabbedPane();</span>

<span class="nc" id="L179">        tabularFormTabPanel = new JPanel();</span>
<span class="nc" id="L180">        createTable();</span>
<span class="nc" id="L181">        tabbedPane.addTab(&quot;Tabular Form&quot;, null, tabularFormTabPanel, &quot;Tabular Form&quot;);</span>

<span class="nc" id="L183">        rawSourceTabPanel = new JPanel();</span>
<span class="nc" id="L184">        createRawSource();</span>
<span class="nc" id="L185">        tabbedPane.addTab(&quot;Raw source&quot;, null, rawSourceTabPanel, &quot;Raw source&quot;);</span>
<span class="nc" id="L186">    }</span>

    private void createTable() {
<span class="nc" id="L189">        children = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L190">        root = new AlarmTreeTableDataNode(&quot;Root&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, children);</span>
<span class="nc" id="L191">        MyAbstractTreeTableModel treeTableModel = new AlarmTreeTableDataModel(root);</span>
<span class="nc" id="L192">        myTreeTable = new MyTreeTable(treeTableModel);</span>
<span class="nc" id="L193">        JScrollPane scrollPane = new JScrollPane(myTreeTable);</span>
<span class="nc" id="L194">        scrollPane.setPreferredSize(new Dimension(Constants.DEFAULT_SCROLL_PANEL_WIDTH, Constants.DEFAULT_SCROLL_PANEL_HEIGHT));</span>
<span class="nc" id="L195">        tabularFormTabPanel.add(scrollPane);</span>
<span class="nc" id="L196">    }</span>

    private void createRawSource() {
<span class="nc" id="L199">        editorPane = new JEditorPane(&quot;text/plain&quot;, &quot;&quot;);</span>
<span class="nc" id="L200">        editorPane.setEditable(false);</span>
<span class="nc" id="L201">        JScrollPane scrollPane = new JScrollPane(editorPane);</span>
<span class="nc" id="L202">        scrollPane.setPreferredSize(new Dimension(Constants.DEFAULT_SCROLL_PANEL_WIDTH, Constants.DEFAULT_SCROLL_PANEL_HEIGHT));</span>
<span class="nc" id="L203">        rawSourceTabPanel.add(scrollPane);</span>
<span class="nc" id="L204">    }</span>

    private void getAlarmInfoStringFromDevice() {
<span class="nc" id="L207">        final String cmd = &quot;adb shell dumpsys alarm&quot;;</span>
<span class="nc" id="L208">        logger.info(cmd);</span>
<span class="nc" id="L209">        try (ByteArrayOutputStream outStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L210">             ByteArrayOutputStream errStream = new ByteArrayOutputStream()</span>
        ) {
<span class="nc" id="L212">            CommandLine commandLine = CommandLine.parse(cmd);</span>
<span class="nc" id="L213">            DefaultExecutor exec = new DefaultExecutor();</span>
<span class="nc" id="L214">            PumpStreamHandler streamHandler = new PumpStreamHandler(outStream, errStream);</span>
<span class="nc" id="L215">            exec.setStreamHandler(streamHandler);</span>
<span class="nc" id="L216">            int exitValue = exec.execute(commandLine);</span>
<span class="nc" id="L217">            logger.info(&quot;exitValue: [&quot; + exitValue + &quot;]&quot;);</span>

<span class="nc" id="L219">            alarmInfoString = outStream.toString(&quot;UTF-8&quot;);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            alarmInfoValid = !StringUtils.isEmpty(alarmInfoString);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (!alarmInfoValid) {</span>
<span class="nc" id="L222">                alarmInfoString = errStream.toString(&quot;UTF-8&quot;);</span>
            }
<span class="nc" id="L224">        } catch (IOException ioe) {</span>
<span class="nc" id="L225">            logger.error(&quot;exec fail&quot;, ioe.getMessage());</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">    }</span>

    private void getAlarmInfoStringFromFile() {
<span class="nc" id="L230">        JFileChooser jfc = new JFileChooser();</span>
<span class="nc" id="L231">        jfc.setFileSelectionMode(JFileChooser.FILES_ONLY);</span>
<span class="nc" id="L232">        jfc.setDialogTitle(&quot;Select a dumpsys alarm file&quot;);</span>
<span class="nc" id="L233">        int ret = jfc.showDialog(new JLabel(), null);</span>
<span class="nc" id="L234">        File file = jfc.getSelectedFile();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        switch (ret) {</span>
            case JFileChooser.APPROVE_OPTION:
                try {
<span class="nc" id="L238">                    alarmInfoString = FileUtils.readFileToString(file, Charset.forName(EncoderDetector.judgeFile(file.getCanonicalPath())));</span>
<span class="nc" id="L239">                    alarmInfoValid = true;</span>
<span class="nc" id="L240">                } catch (IOException ex) {</span>
<span class="nc" id="L241">                    logger.error(&quot;readFileToString failed&quot;, ex);</span>
<span class="nc" id="L242">                    alarmInfoValid = false;</span>
<span class="nc" id="L243">                }</span>
<span class="nc" id="L244">                break;</span>
            default:
                break;
        }
<span class="nc" id="L248">    }</span>

    private void updateUIFromString() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        alarmInfoString = StringUtils.isEmpty(alarmInfoString) ? &quot;&quot; : alarmInfoString;</span>
<span class="nc" id="L252">        editorPane.setText(alarmInfoString);</span>

<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (!alarmInfoValid) {</span>
<span class="nc" id="L255">            children.clear();</span>
<span class="nc" id="L256">            return;</span>
        }

<span class="nc" id="L259">        String tmpInputString = alarmInfoString;</span>

<span class="nc" id="L261">        String timeInformation = StringUtils.substringBetween(alarmInfoString, &quot;nowRTC=&quot;, &quot;mLastTimeChangeClockTime=&quot;).trim().replace(&quot; &quot;, &quot;=&quot;);</span>
<span class="nc" id="L262">        String[] components = timeInformation.split(&quot;=&quot;);</span>

<span class="nc" id="L264">        SharedData sharedData = SharedData.getInstance();</span>
<span class="nc" id="L265">        sharedData.setTimestamp(Long.valueOf(components[0]));</span>
<span class="nc" id="L266">        sharedData.setDateTime(components[1] + &quot; &quot; + components[2]);</span>
<span class="nc" id="L267">        sharedData.setUptimeMs(Long.valueOf(components[4]));</span>

<span class="nc" id="L269">        long uptimeSeconds = sharedData.getUptimeMs() / 1000;</span>
<span class="nc" id="L270">        long uptimeHours = uptimeSeconds / 3600;</span>
<span class="nc" id="L271">        long uptimeMinutes = (uptimeSeconds % 3600) / 60;</span>
<span class="nc" id="L272">        long uptimeSecs = uptimeSeconds % 60;</span>

<span class="nc" id="L274">        systemUptime1Field.setText(String.valueOf(sharedData.getUptimeMs()));</span>
<span class="nc" id="L275">        systemUptime2Field.setText(uptimeHours + &quot;:&quot; + uptimeMinutes + &quot;:&quot; + uptimeSecs);</span>
<span class="nc" id="L276">        lastDateTimeField.setText(sharedData.getDateTime());</span>

<span class="nc" id="L278">        String pendingAlarmBatchesCountStr = StringUtils.substringBetween(tmpInputString, &quot;Pending alarm batches: &quot;, System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc" id="L279">        int pendingAlarmBatches = Integer.valueOf(pendingAlarmBatchesCountStr);</span>
<span class="nc" id="L280">        tmpInputString = StringUtils.substringAfter(tmpInputString, &quot;Pending alarm batches: &quot;);</span>

<span class="nc" id="L282">        List&lt;AlarmBatch&gt; listBatches = new ArrayList&lt;&gt;();</span>
        while (true) {
<span class="nc" id="L284">            String batchDefinition = StringUtils.substringBetween(tmpInputString, &quot;Batch{&quot;, &quot;}:&quot; + System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (StringUtils.isEmpty(batchDefinition)) {</span>
<span class="nc" id="L286">                break;</span>
            }
<span class="nc" id="L288">            AlarmBatch alarmBatch = AlarmBatch.fromString(batchDefinition);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (alarmBatch == null) {</span>
<span class="nc" id="L290">                break;</span>
            }
<span class="nc" id="L292">            String alarmListDefinition = StringUtils.substringBetween(tmpInputString, &quot;}:&quot; + System.getProperty(&quot;line.separator&quot;), &quot;Batch{&quot;);</span>
<span class="nc" id="L293">            alarmListDefinition.replace(&quot;ELAPSED_WAKEUP&quot;, &quot;ELAPSED&quot;).replace(&quot;RTC_WAKEUP&quot;, &quot;ELAPSED&quot;).replace(&quot;RTC&quot;, &quot;ELAPSED&quot;);</span>
<span class="nc" id="L294">            String[] alarmListTmp = alarmListDefinition.split(&quot;ELAPSED&quot;);</span>
<span class="nc" id="L295">            List&lt;String&gt; alarmList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            for (int i = 0; i &lt; alarmListTmp.length; i++) {</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">                if (StringUtils.isNotEmpty(alarmListTmp[i]) &amp;&amp; StringUtils.isNotBlank(alarmListTmp[i])) {</span>
<span class="nc" id="L298">                    alarmList.add(alarmListTmp[i]);</span>
                }
            }

<span class="nc bnc" id="L302" title="All 2 branches missed.">            for (int i = 0; i &lt; alarmList.size(); ++i) {</span>
<span class="nc" id="L303">                Alarm alarm = Alarm.fromString(alarmList.get(i));</span>
<span class="nc bnc" id="L304" title="All 4 branches missed.">                if (StringUtils.isNotEmpty(packageField.getText()) &amp;&amp; StringUtils.equals(alarm.getOwnerPackageName(), packageField.getText())) {</span>
<span class="nc" id="L305">                    continue;</span>
                }
<span class="nc" id="L307">                alarmBatch.appendAlarm(alarm);</span>
            }

<span class="nc" id="L310">            listBatches.add(alarmBatch);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (listBatches.size() == pendingAlarmBatches) {</span>
<span class="nc" id="L312">                break;</span>
            }

<span class="nc" id="L315">            tmpInputString = StringUtils.substringAfter(tmpInputString, &quot;Batch{&quot;);</span>
<span class="nc" id="L316">        }</span>
<span class="nc" id="L317">        children.clear();</span>
<span class="nc" id="L318">        children.addAll(alarmBatches2AlarmTreeTableDataNodeList(listBatches));</span>
<span class="nc" id="L319">    }</span>

    private List&lt;AlarmTreeTableDataNode&gt; alarmBatches2AlarmTreeTableDataNodeList(List&lt;AlarmBatch&gt; listBatches) {
<span class="nc" id="L322">        List&lt;AlarmTreeTableDataNode&gt; sonList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        for (AlarmBatch alarmBatch : listBatches) {</span>
<span class="nc" id="L324">            List&lt;AlarmTreeTableDataNode&gt; grandsonList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L325">            List&lt;Alarm&gt; alarmList = alarmBatch.getListAlarms();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            for (Alarm alarm : alarmList) {</span>
<span class="nc" id="L327">                String objectId = alarm.getSignature() + &quot; [&quot; + alarm.getId() + &quot;]&quot;;</span>
<span class="nc" id="L328">                AlarmTreeTableDataNode grandson = new AlarmTreeTableDataNode(objectId, alarm.getOwnerPackageName(), alarm.getAlarmType(), String.valueOf(alarm.getWhen()),String.valueOf(alarm.getWhen()), null);</span>
<span class="nc" id="L329">                grandsonList.add(grandson);</span>
<span class="nc" id="L330">            }</span>
<span class="nc" id="L331">            String objectId = alarmBatch.getSignature() + &quot; [&quot; + alarmBatch.getId() + &quot;] (&quot; + alarmBatch.getAlarmCount() + &quot; alarms)&quot;;</span>
<span class="nc" id="L332">            AlarmTreeTableDataNode son = new AlarmTreeTableDataNode(objectId, null, null, null, null, grandsonList);</span>
<span class="nc" id="L333">            sonList.add(son);</span>
<span class="nc" id="L334">        }</span>
<span class="nc" id="L335">        return sonList;</span>
    }

<span class="nc" id="L338">    private final class LoadFromDeviceButtonMouseAdapter extends MouseAdapter {</span>
        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc" id="L341">            super.mousePressed(e);</span>
<span class="nc" id="L342">            getAlarmInfoStringFromDevice();</span>
<span class="nc" id="L343">            updateUIFromString();</span>
<span class="nc" id="L344">        }</span>
    }

<span class="nc" id="L347">    private final class LoadFromFileButtonMouseAdapter extends MouseAdapter {</span>
        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc" id="L350">            super.mousePressed(e);</span>
<span class="nc" id="L351">            getAlarmInfoStringFromFile();</span>
<span class="nc" id="L352">            updateUIFromString();</span>
<span class="nc" id="L353">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>